# 🏦 地方銀行証券データ抽出システム

地方銀行の主要勘定PDFファイルから証券データを自動抽出し、データベースに保存・可視化するStreamlitアプリケーションです。

## 📋 目次

- [機能概要](#機能概要)
- [システム要件](#システム要件)
- [インストール](#インストール)
- [使用方法](#使用方法)
- [機能詳細](#機能詳細)
- [ファイル構成](#ファイル構成)
- [データ形式](#データ形式)
- [トラブルシューティング](#トラブルシューティング)

## � スクリーンショット

### メイン画面
アプリケーションは以下の2つの主要ページで構成されています：

#### 1. データ抽出ページ
- PDFファイルのアップロード
- 自動データ抽出とデバッグ情報表示  
- データの手動修正と確定
- データベースへの保存とCSVエクスポート
- 既存データベースの内容表示

#### 2. グラフ表示ページ
- グラフカテゴリ選択（金額 / 比率）
- 複数のグラフタイプ（棒・線・エリア・円グラフ）
- インタラクティブなデータ可視化
- 詳細な統計情報と分析結果

### 主要機能の画面フロー
```
PDFアップロード → データ抽出 → 確認・修正 → データベース保存 → グラフ表示・分析
```

## �🚀 機能概要

### 主要機能
- **PDFデータ抽出**: 地方銀行主要勘定PDFから証券データを自動抽出
- **データベース管理**: Excelファイルでのデータ永続化と管理
- **インタラクティブ可視化**: 複数のグラフタイプでのデータ表示
- **比率分析**: 構成比率の計算と傾向分析
- **データエクスポート**: CSV形式でのデータダウンロード

### 対応証券種類
- 国債
- 地方債
- 短期社債
- 社債
- 株式
- 外国証券
- その他の証券

## 💻 システム要件

### 必要なソフトウェア
- Python 3.7以上
- pip (Pythonパッケージマネージャー)

### 対応OS
- Windows 10/11
- macOS
- Linux

## 🔧 インストール

### 1. リポジトリのクローン
```bash
git clone https://github.com/yuki27739/rb_kessan.git
cd rb_kessan
```

### 2. 依存関係のインストール
```bash
pip install -r requirements.txt
```

### 3. アプリケーションの起動
```bash
streamlit run app.py
```

ブラウザで `http://localhost:8501` にアクセスしてアプリケーションを使用できます。

## 📖 使用方法

### 1. データ抽出（基本的な使用手順）

#### Step 1: PDFファイルのアップロード
1. サイドバーで「データ抽出」ページを選択
2. 「PDFファイルを選択してください」からPDFファイルをアップロード
3. 地方銀行主要勘定のPDFファイル（2ページ目に証券データが含まれるもの）を選択

#### Step 2: データの確認・修正
1. 自動抽出されたデータを確認
2. 必要に応じて「データの確認・修正」セクションで値を修正
3. 年月形式（YYYY-MM）と各証券の金額（百万円単位）を入力
4. 「確定」ボタンをクリック

#### Step 3: データの保存
1. 確定されたデータを確認
2. 「データベースに保存」で永続化
3. または「CSVファイルをダウンロード」で個別データをエクスポート

### 2. グラフ表示・分析

#### Step 1: グラフページへの移動
1. サイドバーで「グラフ表示」ページを選択

#### Step 2: グラフカテゴリの選択
- **金額グラフ**: 絶対金額での時系列分析
- **比率グラフ**: 構成比率での分析

#### Step 3: グラフタイプの選択

**金額グラフ**:
- 積み上げ棒グラフ: 各期間の証券構成を棒グラフで表示
- 線グラフ: 各証券の時系列変化を線で表示
- エリアグラフ: 積み上げエリアでの時系列表示

**比率グラフ**:
- 円グラフ（最新期）: 最新期間の構成比率を円グラフで表示
- 比率積み上げ棒グラフ: 各期間の構成比率を100%積み上げで表示
- 比率線グラフ: 各証券の構成比率変化を線で表示

## 🎯 機能詳細

### データ抽出機能

#### 自動抽出アルゴリズム
1. **テキスト解析**: PDFからテキストを抽出し、証券名パターンをマッチング
2. **正規表現処理**: スペースや文字の変動に対応した柔軟なパターンマッチング
3. **テーブル解析**: PDF内のテーブル構造を解析して数値を抽出
4. **データ検証**: 抽出された数値の妥当性をチェック

#### デバッグ機能
- 抽出されたPDFテキストの表示
- テーブル構造の詳細表示
- 抽出処理ログの表示
- 証券別の抽出結果確認

### データベース管理

#### Excelファイル形式
- ファイル名: `data/securities_database.xlsx`
- 自動ソート: 年月昇順でデータを整理
- 重複管理: 同一年月のデータは上書き更新

#### データ構造
```
年月 | 国債 | 地方債 | 短期社債 | 社債 | 株式 | 外国証券 | その他の証券 | 更新日時
```

### 可視化機能

#### 金額グラフ
- **積み上げ棒グラフ**: 各期間の絶対金額と構成を表示
- **線グラフ**: 時系列での変化トレンドを分析
- **エリアグラフ**: 積み上げ面積での全体像把握

#### 比率グラフ
- **円グラフ**: 最新期間のポートフォリオ構成を視覚化
- **比率積み上げ棒グラフ**: 構成比率の時系列変化を表示
- **比率線グラフ**: 各証券の比率変動トレンドを分析

#### 分析機能
- **統計情報**: データ期間数、最新期合計、期間平均等
- **構成比率分析**: 平均比率、標準偏差、変動係数の計算
- **傾向分析**: 期間全体での主要な構成比変化の検出

## 📁 ファイル構成

```
rb_kessan/
├── app.py                          # メインアプリケーション
├── requirements.txt                # 依存関係定義
├── README.md                      # プロジェクト説明書
├── data/                          # データディレクトリ
│   ├── securities_database.xlsx   # 証券データベース（自動生成）
│   ├── kessan/                    # 決算データ
│   │   ├── kessan2020.xls
│   │   ├── kessan2021.xls
│   │   ├── kessan2022.xlsx
│   │   ├── kessan2023.xlsx
│   │   └── kessan2024.xlsx
│   └── matuhei/                   # 末平データ
│       ├── matuhei202003.pdf
│       ├── matuhei202006.pdf
│       └── ... (その他のPDFファイル)
```

## 📊 データ形式

### 入力データ（PDF）
- **ファイル形式**: PDF
- **対象ページ**: 2ページ目
- **必要な情報**: 年月、各証券種類の金額（百万円単位）

### 出力データ（Excel/CSV）
```csv
年月,国債,地方債,短期社債,社債,株式,外国証券,その他の証券,更新日時
2024-03,50000,30000,10000,20000,15000,5000,2000,2024-03-15 14:30:00
2024-06,52000,32000,12000,18000,16000,4000,1500,2024-06-18 09:45:00
```

## 🛠️ トラブルシューティング

### よくある問題と解決方法

#### 1. PDFデータが正しく抽出されない
**症状**: 証券データが0になる、または間違った値が抽出される

**解決方法**:
- デバッグ用セクションを開いて抽出ログを確認
- PDFの2ページ目に証券データが含まれているかチェック
- 手動でデータを修正して確定ボタンを押す

#### 2. アプリケーションが起動しない
**症状**: `streamlit run app.py`でエラーが発生

**解決方法**:
```bash
# 依存関係を再インストール
pip install --upgrade -r requirements.txt

# Pythonバージョンの確認（3.7以上が必要）
python --version

# 仮想環境の使用を推奨
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

#### 3. データベースファイルが作成されない
**症状**: `data/securities_database.xlsx`が生成されない

**解決方法**:
- `data`ディレクトリが存在するか確認
- 書き込み権限があるか確認
- 手動で`data`ディレクトリを作成

#### 4. グラフが表示されない
**症状**: グラフ表示ページでエラーが発生

**解決方法**:
- データベースにデータが存在するか確認
- まずデータ抽出ページでPDFを処理してデータを追加
- ブラウザのキャッシュをクリア

### パフォーマンス最適化

#### 大量データの処理
- データベースファイルサイズが大きくなった場合は定期的なアーカイブを推奨
- 表示する期間を制限する機能の追加を検討

#### メモリ使用量
- 大きなPDFファイルを処理する際はメモリ使用量に注意
- 必要に応じてPDFファイルを分割して処理

## 🤝 コントリビューション

### 開発環境のセットアップ
1. フォークしてクローン
2. 仮想環境を作成
3. 依存関係をインストール
4. 変更を加えてプルリクエストを作成

### コードスタイル
- PEP 8準拠
- 関数とクラスにdocstringを追加
- 意味のある変数名と関数名を使用

## 📜 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 👥 作者

- **Author**: yuki27739
- **Repository**: https://github.com/yuki27739/rb_kessan

## 📞 サポート

問題や質問がある場合は、以下の方法でお問い合わせください：

1. **Issues**: GitHubのIssuesページで報告
2. **Discussions**: 機能要望や質問はDiscussionsで
3. **Email**: 緊急の問題は直接連絡

---

**最終更新日**: 2025年7月24日
**バージョン**: 1.0.0
