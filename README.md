# 地方銀行財務データ抽出システム

🏦 地方銀行主要勘定PDFから貸出金・証券データを抽出し、時系列分析を行うStreamlitアプリケーション

## 📋 概要

このシステムは、地方銀行の主要勘定PDFファイルから有価証券と貸出金のデータを自動抽出し、構成比の変動分析を行うツールです。抽出したデータはExcelデータベースに保存され、インタラクティブなグラフで可視化できます。

## ✨ 主な機能

### 1. データ抽出機能
- **PDF自動解析**: 地方銀行主要勘定PDFから証券データを自動抽出
- **データ検証**: 抽出したデータの確認・修正機能
- **データベース保存**: Excelファイルでの永続化
- **CSV出力**: 個別データおよび全データのCSVエクスポート

### 2. グラフ分析機能
- **グラフ1**: 円債の有価証券に占める構成比の変動（折れ線グラフ）
- **グラフ2**: 円債と貸出金の構成比の変動（折れ線グラフ）
- **グラフ3**: リスク性証券の有価証券に占める構成比の変動（折れ線グラフ）
- **グラフ4**: 有価証券の構成比の推移（積み上げ棒グラフ）

### 3. 分析対象データ
- **円債**: 国債、地方債、短期社債、社債
- **リスク性証券**: 株式、外国証券、その他の証券
- **その他**: 貸出金

## 🚀 セットアップ方法

### 前提条件
- Python 3.12.9
- pyenv（Pythonバージョン管理）

### インストール手順

1. **リポジトリのクローン**
   ```bash
   git clone <repository-url>
   cd rb_kessan
   ```

2. **Python 3.12.9のインストール（必要な場合）**
   ```bash
   pyenv install 3.12.9
   ```

3. **Pythonバージョンの設定**
   ```bash
   pyenv local 3.12.9
   ```

4. **仮想環境の作成**
   ```bash
   python -m venv venv
   ```

5. **仮想環境のアクティベート**
   
   **Windows (PowerShell):**
   ```powershell
   venv\Scripts\Activate.ps1
   ```
   
   **Windows (Command Prompt):**
   ```cmd
   venv\Scripts\activate.bat
   ```
   
   **macOS/Linux:**
   ```bash
   source venv/bin/activate
   ```

6. **依存関係のインストール**
   ```bash
   pip install -r requirements.txt
   ```

## 🎯 使用方法

### アプリケーションの起動
```bash
streamlit run app.py
```

ブラウザで `http://localhost:8501` にアクセスしてアプリケーションを使用します。

### データ抽出の流れ

1. **データ抽出ページ**でPDFファイルをアップロード
2. 自動抽出されたデータを確認・修正
3. データベースに保存またはCSVでダウンロード

### グラフ分析の流れ

1. **グラフ表示ページ**で表示期間を選択（デフォルト：直近5期間）
2. 4つのグラフで構成比の変動を分析
3. データテーブルで詳細数値を確認

## 📊 グラフの詳細

### グラフ1-3: 構成比変動分析
- **基準点**: 選択期間の最初の時点を0%ポイントとする
- **表示形式**: 折れ線グラフ（マーカー付き）
- **基準線**: y=0ラインを太い黒線で表示
- **単位**: %ポイント（パーセンテージポイント）

### グラフ4: 構成比推移
- **表示形式**: 積み上げ棒グラフ
- **単位**: %（パーセンテージ）
- **合計**: 常に100%

## 📁 ファイル構成

```
rb_kessan/
├── app.py                      # メインアプリケーション
├── requirements.txt           # Python依存関係
├── README.md                  # このファイル
├── .python-version           # pyenvバージョン指定
├── data/                     # データディレクトリ
│   ├── securities_database.xlsx  # 証券データベース（自動作成）
│   ├── kessan/              # 決算データ用フォルダ
│   └── matuhei/             # 末平データ用フォルダ
└── venv/                    # 仮想環境（gitignore対象）
```

## 🔧 技術仕様

### 使用技術
- **Python**: 3.12.9
- **Streamlit**: Webアプリケーションフレームワーク
- **pdfplumber**: PDF解析ライブラリ
- **pandas**: データ処理
- **plotly**: インタラクティブグラフ作成
- **openpyxl**: Excelファイル操作

### データ処理
- **抽出方式**: PDFテキスト解析 + テーブル構造解析
- **データベース**: Excel形式（.xlsx）
- **文字エンコーディング**: UTF-8
- **日付形式**: YYYY-MM

## 📝 データフォーマット

### 入力データ
- **ファイル形式**: PDF
- **想定構造**: 地方銀行主要勘定の標準フォーマット
- **抽出対象**: 2ページ目の証券・貸出金データ

### 出力データ
- **年月**: YYYY-MM形式
- **金額**: 百万円単位（整数）
- **更新日時**: データ保存時刻

## 🐛 トラブルシューティング

### よくある問題

1. **PDFが読み込めない**
   - ファイルが破損していないか確認
   - 2ページ目が存在するか確認
   - ファイル形式がPDFか確認

2. **数値が正しく抽出されない**
   - デバッグ用展開セクションで抽出ログを確認
   - 手動でデータを修正してから保存

3. **グラフが表示されない**
   - データベースにデータが保存されているか確認
   - 選択期間にデータが存在するか確認

### デバッグ機能
- **PDFテキスト表示**: 抽出されたテキストを確認
- **テーブル構造表示**: 解析されたテーブル構造を確認
- **抽出ログ表示**: データ抽出処理の詳細ログ

## 📈 分析の特徴

### 変動分析の意義
- **構成比変動**: 開始時点からの%ポイント変化を追跡
- **トレンド把握**: 資産配分の変化傾向を可視化
- **比較分析**: 複数の証券種別の変動パターンを同時比較

### 表示期間のカスタマイズ
- **デフォルト**: 直近5期間
- **選択可能**: データベース内の全期間から自由に選択
- **最小**: 1期間から分析可能

## 📄 ライセンス

このプロジェクトは個人利用・研究目的で作成されています。

## 🤝 サポート

問題が発生した場合は、以下の手順で対処してください：

1. デバッグ用展開セクションでログを確認
2. データの手動修正を試行
3. 必要に応じてCSVエクスポートでデータをバックアップ

---

**最終更新**: 2025年7月25日  
**バージョン**: 1.0.0
